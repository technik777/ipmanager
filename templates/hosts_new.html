{% extends "base.html" %}
{% block title %}Host anlegen{% endblock title %}
{% block content %}
<h1>Host anlegen</h1>

{% if error %}
<p style="color: red;">{{ error }}</p>
{% endif %}

<form method="post" action="/hosts">
  <label>
    Hostname<br />
    <input name="hostname" required value="{{ form.hostname | default(value='') }}" />
  </label>
  <br /><br />

  <label>
    IP (IPv4/IPv6)<br />
    <input name="ip" required value="{{ form.ip | default(value='') }}" />
  </label>
  <br /><br />

  <label>
    MAC (wird normalisiert)<br />
    <input name="mac" required value="{{ form.mac | default(value='') }}" />
  </label>
  <br /><br />

  <label>
    Standort<br />
    <select id="location_id" name="location_id" required>
      {% if locations | length == 0 %}
        <option value="" selected disabled>Keine Standorte vorhanden</option>
      {% else %}
        <option value="" {% if not form.location_id %}selected{% endif %}>Bitte wählen…</option>
        {% for l in locations %}
          <option value="{{ l.id }}" {% if form.location_id == l.id %}selected{% endif %}>{{ l.name }}</option>
        {% endfor %}
      {% endif %}
    </select>
  </label>
  <br /><br />

  <label>
    LAN-Dose<br />
    <select id="lan_outlet_id" name="lan_outlet_id" required disabled>
      <option value="" selected>Bitte zuerst Standort wählen…</option>
    </select>
  </label>
  <br /><br />

  <label>
    Subnet<br />
    <select name="subnet_id" required>
      {% if subnets | length == 0 %}
        <option value="" selected disabled>Keine Subnetze vorhanden – zuerst Subnetz anlegen</option>
      {% else %}
        <option value="" {% if not form.subnet_id %}selected{% endif %} disabled>Bitte wählen…</option>
        {% for s in subnets %}
          <option value="{{ s.id }}" {% if form.subnet_id == s.id %}selected{% endif %}>{{ s.name }} ({{ s.cidr }})</option>
        {% endfor %}
      {% endif %}
    </select>
  </label>
  <br /><br />

  <label>
    PXE enabled
    <input type="checkbox" name="pxe_enabled" value="true" {% if form.pxe_enabled %}checked{% endif %} />
  </label>
  <br /><br />

  <button type="submit">Speichern</button>
</form>

<script>
(function () {
  const locationSel = document.getElementById("location_id");
  const outletSel = document.getElementById("lan_outlet_id");
  const initialLocationId = "{{ form.location_id | default(value='') }}";
  const initialOutletId = "{{ form.lan_outlet_id | default(value='') }}";

  function setOutletPlaceholder(text) {
    outletSel.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = text;
    opt.selected = true;
    outletSel.appendChild(opt);
  }

  async function loadOutlets(locationId, selectedOutletId) {
    outletSel.disabled = true;
    setOutletPlaceholder("Lade LAN-Dosen…");

    try {
      const res = await fetch(`/api/lan-outlets?location_id=${encodeURIComponent(locationId)}`, {
        headers: { "Accept": "application/json" }
      });

      if (!res.ok) {
        setOutletPlaceholder("Fehler beim Laden");
        return;
      }

      const items = await res.json();

      outletSel.innerHTML = "";
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "Bitte wählen…";
      outletSel.appendChild(empty);

      for (const it of items) {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.label;
        if (selectedOutletId && selectedOutletId === it.id) {
          opt.selected = true;
        }
        outletSel.appendChild(opt);
      }

      outletSel.disabled = false;
      if (items.length === 0) {
        setOutletPlaceholder("Keine LAN-Dosen für Standort");
        outletSel.disabled = true;
      }
    } catch (e) {
      setOutletPlaceholder("Fehler beim Laden");
    }
  }

  locationSel.addEventListener("change", () => {
    const loc = locationSel.value;
    if (!loc) {
      outletSel.disabled = true;
      setOutletPlaceholder("Bitte zuerst Standort wählen…");
      return;
    }
    loadOutlets(loc, null);
  });

  if (initialLocationId) {
    locationSel.value = initialLocationId;
    loadOutlets(initialLocationId, initialOutletId || null);
  }
})();
</script>

{% endblock content %}
