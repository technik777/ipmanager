{% extends "base.html" %}
{% block title %}Host anlegen{% endblock title %}
{% block content %}
<h1>Host anlegen</h1>

{% if error %}
<p style="color: red;">{{ error }}</p>
{% endif %}

<form method="post" action="/hosts">
  <label>
    Hostname<br />
    <input name="hostname" required value="{{ form.hostname | default(value='') }}" />
  </label>
  <br /><br />

  <label>
    Subnet<br />
    <select name="subnet_id" required>
      {% if subnets | length == 0 %}
        <option value="" selected disabled>Keine Subnetze vorhanden – zuerst Subnetz anlegen</option>
      {% else %}
        <option value="" {% if not form.subnet_id %}selected{% endif %} disabled>Bitte wählen…</option>
        {% for s in subnets %}
          <option value="{{ s.id }}" {% if form.subnet_id == s.id %}selected{% endif %}>{{ s.name }} ({{ s.cidr }})</option>
        {% endfor %}
      {% endif %}
    </select>
  </label>
  <br /><br />

  <label>
    IP (IPv4/IPv6)<br />
    <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap;">
      <input name="ip" required value="{{ form.ip | default(value='') }}" placeholder="{{ suggested_ip | default(value='') }}" />
      <button type="button" id="find-free-ip-btn">Freie IP finden</button>
      <span id="free-ip-result" style="color:#555;"></span>
    </div>
  </label>
  <br /><br />

  <label>
    MAC (wird normalisiert)<br />
    <input name="mac" required value="{{ form.mac | default(value='') }}" />
  </label>
  <br /><br />

  <label>
    Standort<br />
    <select id="location_id" name="location_id" required>
      {% if locations | length == 0 %}
        <option value="" selected disabled>Keine Standorte vorhanden</option>
      {% else %}
        <option value="" {% if not form.location_id %}selected{% endif %}>Bitte wählen…</option>
        {% for l in locations %}
          <option value="{{ l.id }}" {% if form.location_id == l.id %}selected{% endif %}>{{ l.name }}</option>
        {% endfor %}
      {% endif %}
    </select>
  </label>
  <br /><br />

  <label>
    LAN-Dose<br />
    <select id="lan_outlet_id" name="lan_outlet_id" required disabled>
      <option value="" selected>Bitte zuerst Standort wählen…</option>
    </select>
  </label>
  <br /><br />

  <label>
    PXE enabled
    <input type="checkbox" name="pxe_enabled" value="true" {% if form.pxe_enabled %}checked{% endif %} />
  </label>
  <br /><br />

  <label>
    PXE Image<br />
    <select name="pxe_image_id" {% if pxe_images | length == 0 %}disabled{% endif %}>
      <option value="" {% if not form.pxe_image_id %}selected{% endif %}>Kein PXE-Image</option>
      {% for img in pxe_images %}
        <option value="{{ img.id }}" {% if form.pxe_image_id == img.id %}selected{% endif %}>{{ img.name }}</option>
      {% endfor %}
    </select>
  </label>
  {% if pxe_images | length == 0 %}
    <div style="color:#a33; margin: 6px 0 12px 0;">
      Keine PXE-Images vorhanden – bitte zuerst eines unter <a href="/pxe/images/new">PXE Images</a> anlegen.
    </div>
  {% else %}
    <br /><br />
  {% endif %}

  <button type="submit">Speichern</button>
</form>

<script>
(function () {
  const locationSel = document.getElementById("location_id");
  const outletSel = document.getElementById("lan_outlet_id");
  const initialLocationId = "{{ form.location_id | default(value='') }}";
  const initialOutletId = "{{ form.lan_outlet_id | default(value='') }}";

  function setOutletPlaceholder(text) {
    outletSel.innerHTML = "";
    const opt = document.createElement("option");
    opt.value = "";
    opt.textContent = text;
    opt.selected = true;
    outletSel.appendChild(opt);
  }

  async function loadOutlets(locationId, selectedOutletId) {
    outletSel.disabled = true;
    setOutletPlaceholder("Lade LAN-Dosen…");

    try {
      const res = await fetch(`/api/lan-outlets?location_id=${encodeURIComponent(locationId)}`, {
        headers: { "Accept": "application/json" }
      });

      if (!res.ok) {
        setOutletPlaceholder("Fehler beim Laden");
        return;
      }

      const items = await res.json();

      outletSel.innerHTML = "";
      const empty = document.createElement("option");
      empty.value = "";
      empty.textContent = "Bitte wählen…";
      outletSel.appendChild(empty);

      for (const it of items) {
        const opt = document.createElement("option");
        opt.value = it.id;
        opt.textContent = it.label;
        if (selectedOutletId && selectedOutletId === it.id) {
          opt.selected = true;
        }
        outletSel.appendChild(opt);
      }

      outletSel.disabled = false;
      if (items.length === 0) {
        setOutletPlaceholder("Keine LAN-Dosen für Standort");
        outletSel.disabled = true;
      }
    } catch (e) {
      setOutletPlaceholder("Fehler beim Laden");
    }
  }

  locationSel.addEventListener("change", () => {
    const loc = locationSel.value;
    if (!loc) {
      outletSel.disabled = true;
      setOutletPlaceholder("Bitte zuerst Standort wählen…");
      return;
    }
    loadOutlets(loc, null);
  });

  if (initialLocationId) {
    locationSel.value = initialLocationId;
    loadOutlets(initialLocationId, initialOutletId || null);
  }

  // Freie IP suchen
  const findBtn = document.getElementById("find-free-ip-btn");
  const subnetSel = document.querySelector("select[name='subnet_id']");
  const ipInput = document.querySelector("input[name='ip']");
  const resultSpan = document.getElementById("free-ip-result");
  const initialSuggested = "{{ suggested_ip | default(value='') }}";

  async function findFreeIp() {
    const subnetId = subnetSel.value;
    if (!subnetId) {
      resultSpan.textContent = "Bitte zuerst Subnet wählen.";
      resultSpan.style.color = "#a33";
      return;
    }
    resultSpan.textContent = "Suche freie IP...";
    resultSpan.style.color = "#555";
    try {
      const res = await fetch(`/api/find-free-ip?subnet_id=${encodeURIComponent(subnetId)}`, {
        headers: { "Accept": "application/json" }
      });
      if (!res.ok) {
        const text = await res.text();
        resultSpan.textContent = text || "Keine freie IP gefunden.";
        resultSpan.style.color = "#a33";
        return;
      }
      const data = await res.json();
      ipInput.value = data.free_ip;
      resultSpan.textContent = `Freie IP: ${data.free_ip}`;
      resultSpan.style.color = "#2d7a2d";
    } catch (e) {
      resultSpan.textContent = "Fehler beim Suchen.";
      resultSpan.style.color = "#a33";
    }
  }

  findBtn.addEventListener("click", findFreeIp);
  subnetSel.addEventListener("change", findFreeIp);
  if (initialSuggested && !ipInput.value) {
    ipInput.value = initialSuggested;
    resultSpan.textContent = `Freie IP: ${initialSuggested}`;
    resultSpan.style.color = "#2d7a2d";
  }
})();
</script>

{% endblock content %}
